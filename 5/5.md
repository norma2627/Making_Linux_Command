# ストリーム
ストリーム
- システムコール
- ライブラリ関数


## システムコール
主要なシステムコール
- ストリームからバイト列を読み込むread
- ストリームにバイト列を書き込むwirte
- ストリームを作るopen
- 用済みのストリームを始末するclose

## ファイルディスクプリタ
プロセスからストリームを扱うために使用する。
file descriptor: ファイル記述子と訳す場合もある。

### ファイルディスクプリタ
プログラムから見ると整数値(int)
カーネルが持っているストリームを番号と対応付け、プロセスには番号でストリームを指定させる。
※ストリームをプロセスに直接見せることができないため


## 標準入力、標準出力、昇順エラー出力
ファイルディスクプリタを知るには？
- プロセスの開始から使えることが分かっている、きぞんのファイルディスクプリタを使用すること。

シェルからプロセスが起動された場合に、用意されているストリーム
1. 標準入力(Standard input)
2. 標準出力(Standard output)
3. 標準エラー出力(Standard error output)
※それぞれ、ディスクプリタの0番,1番,2番に対応する。
→番号を書かなくても良いように,マクロも用意されている。
- STDIN_FILENO.
- STDOUT_FILENO
- STDERR_FILENO

### 標準入力と標準出力
標準入力、標準出力が用意される理由は？
- コマンドを様々に組み合わせて使えるようにするため。
コマンドが標準入力からデータを読み込み、処理結果を標準出力に書き込むようになっている。
「標準」→「デフォルトの」に近い意味。
標準入力はプログラムのデフォルト入力元であり、標準出力はデフォルト出力先ということ。

e.g. catコマンドを単独で起動した場合:
標準入力→端末(キーボードからの入力)につながる
標準出力→端末(モニタへの出力)につながる
Enterを押すたびに、そのまま端末に表示される。

e.g $cat
端末(入力)→catプロセス→端末(出力)
キーボードを押す度に、そのまま端末に表示される。

e.g. $cat < hello.c   (ファイルをcatコマンドにリダイレクト)
ファイル(hello.c)→catプロセス→端末(出力)
1. 標準入力がファイルにつながる。
2. ファイルの内容が端末に表示される。
※標準入力にファイルへのストリームをつなぐ作業はシェルが行う→catコマンドは自分がファイルから読み込んでいることを知らない。

e.g. $grep print < hello.c | head
ファイル(hello.c)→grepプロセス→headプロセス→端末(出力)
grep, headコマンドは、それぞれ標準入力から読み込んで標準出力に書き込んでいる。

『標準入力から読み込んで標準出力に書き込む』という約束事に従って、Linuxコマンドが動作している。

### 標準エラー出力
エラーメッセージを出すときに使用する。

なぜ標準エラー出力が用意されているか？
- パイプがあるから(標準出力が、次の標準入力につながれている場合)
エラーメッセージを標準入力に出してしまうと、ユーザがエラーに気づかない可能性が高い
プログラムに渡したい出力: 標準出力
人間に読ませたい出力: 標準エラー出力


| ファイルディスクプリタ  | マクロ | 意味 |
| ------------- | ------------- | ------------- |
| 0  | STDIN_EILENO  | 標準入力、デフォルトの入力元  |
| 1  | STDOUT_FILENO  | 標準出力、デフォルトの出力先  |
| 2  | STDERR_FILENO  | 標準エラー出力、人間向けメッセージの出力先  |


## ストリームの読み書き
ストリームの読み書きに使用するシステムコール
- read()
- write()

### read(2)
[ストリームからバイト列を読み込むのに使用するシステムコール](./read.c)


### write(2)
[bufsizeバイト分をbufからファイルディスクプリタfd番のストリームに書き込む](./write.c)
戻り値の型はssize_tなので、符号付き整数。
正常に書き込んだ時は書いたバイト数を返す。エラーが起きた時は-1を返す。
write()がbufsizeバイトをすべてかけない状況は比較的少ない。
現実的な確率で発生する。厳密な処理が必要な場面では戻り値をチェックすべき。

